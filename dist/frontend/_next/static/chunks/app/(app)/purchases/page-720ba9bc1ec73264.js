(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[628],{333:(e,s,a)=>{"use strict";a.d(s,{d:()=>i});var t=a(5155),n=a(2115),r=a(4884),l=a(9434);let i=n.forwardRef((e,s)=>{let{className:a,...n}=e;return(0,t.jsx)(r.bL,{className:(0,l.cn)("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",a),...n,ref:s,children:(0,t.jsx)(r.zi,{className:(0,l.cn)("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})})});i.displayName=r.bL.displayName},1464:(e,s,a)=>{Promise.resolve().then(a.bind(a,7446))},1475:(e,s,a)=>{"use strict";a.d(s,{E:()=>h});var t=a(5155),n=a(2115),r=a(285),l=a(4165),i=a(5057),c=a(2523),d=a(333),o=a(1689),u=a(8539),x=a(5731);function h(e){var s,a,h,m,p;let{open:j,onOpenChange:g,product:N,onProductSaved:v,generateSku:f}=e,[b,y]=(0,n.useState)(null),[C,w]=(0,n.useState)(!1),[k,_]=(0,n.useState)({});(0,n.useEffect)(()=>{if(N){let e={...N};void 0===N.id&&f&&(e.sku=f()),void 0===e.tax_rate&&(e.tax_rate=16),y(e),w(0===e.tax_rate)}else y(null),w(!1)},[N,f]);let A=async()=>{var e;if(!b)return;let s={};if((""===b.price||null===b.price||isNaN(Number(b.price)))&&(s.price="El precio es obligatorio y debe ser un n\xfamero."),(""===b.stock||null===b.stock||isNaN(Number(b.stock)))&&(s.stock="El stock es obligatorio y debe ser un n\xfamero."),!C&&(""===b.tax_rate||null===b.tax_rate||isNaN(Number(b.tax_rate)))&&(s.tax_rate="La tasa de impuesto es obligatoria y debe ser un n\xfamero."),_(s),Object.keys(s).length>0)return void Object.values(s).forEach(e=>{(0,o.Kf)("Error de validaci\xf3n",e)});let a={...b,price:parseFloat(String(b.price)),stock:parseInt(String(b.stock),10),status:null!=(e=b.status)?e:"Activo",tax_rate:C?0:parseFloat(String(b.tax_rate))};try{if("id"in a&&a.id)await (0,x.vc)(a.id,a),v(a);else{let e=await (0,x.WY)(a);v(e)}S()}catch(e){console.error("Error al guardar el producto:",e)}},S=()=>{g(!1),_({})};return(0,t.jsx)(l.lG,{open:j,onOpenChange:g,children:(0,t.jsxs)(l.Cf,{className:"sm:max-w-[425px]",children:[(0,t.jsxs)(l.c7,{children:[(0,t.jsx)(l.L3,{children:(null==b?void 0:b.id)?"Editar Producto":"A\xf1adir Nuevo Producto"}),(0,t.jsx)(l.rr,{children:(null==b?void 0:b.id)?"Modifica los detalles del producto.":"Completa los detalles para crear un nuevo producto."})]}),b&&(0,t.jsxs)("div",{className:"grid gap-4 py-4",children:[(0,t.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,t.jsx)(i.J,{htmlFor:"name",className:"text-right",children:"Nombre"}),(0,t.jsx)(c.p,{id:"name",value:b.name,onChange:e=>y({...b,name:e.target.value}),className:"col-span-3"})]}),(0,t.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,t.jsx)(i.J,{htmlFor:"sku",className:"text-right",children:"SKU"}),(0,t.jsx)(c.p,{id:"sku",value:null!=(s=b.sku)?s:"",onChange:e=>y({...b,sku:e.target.value}),className:"col-span-3"})]}),(0,t.jsxs)("div",{className:"grid grid-cols-4 items-start gap-4",children:[(0,t.jsx)(i.J,{htmlFor:"description",className:"text-right pt-2",children:"Descripci\xf3n"}),(0,t.jsx)(u.T,{id:"description",value:null!=(a=b.description)?a:"",onChange:e=>y({...b,description:e.target.value}),className:"col-span-3",rows:3})]}),(0,t.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,t.jsx)(i.J,{htmlFor:"price",className:"text-right",children:"Precio"}),(0,t.jsx)(c.p,{id:"price",type:"text",value:null!=(h=b.price)?h:"",onChange:e=>{y({...b,price:e.target.value}),k.price&&_({...k,price:void 0})},className:"col-span-3 ".concat(k.price?"border-red-500":"")})]}),(0,t.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,t.jsx)(i.J,{htmlFor:"stock",className:"text-right",children:"Stock"}),(0,t.jsx)(c.p,{id:"stock",type:"text",value:null!=(m=b.stock)?m:"",onChange:e=>{y({...b,stock:e.target.value}),k.stock&&_({...k,stock:void 0})},className:"col-span-3 ".concat(k.stock?"border-red-500":"")})]}),(0,t.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,t.jsx)(i.J,{htmlFor:"tax-exempt",className:"text-right",children:"Exento"}),(0,t.jsxs)("div",{className:"flex items-center space-x-2 col-span-3",children:[(0,t.jsx)(d.d,{id:"tax-exempt",checked:C,onCheckedChange:w}),(0,t.jsx)(i.J,{htmlFor:"tax-exempt",className:"font-normal",children:C?"S\xed, exento de impuestos":"No, sujeto a impuestos"})]})]}),!C&&(0,t.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,t.jsx)(i.J,{htmlFor:"tax_rate",className:"text-right",children:"Tasa (%)"}),(0,t.jsx)(c.p,{id:"tax_rate",type:"text",value:null!=(p=b.tax_rate)?p:"16",onChange:e=>{y({...b,tax_rate:e.target.value}),k.tax_rate&&_({...k,tax_rate:void 0})},className:"col-span-3 ".concat(k.tax_rate?"border-red-500":"")})]}),(0,t.jsxs)("div",{className:"grid grid-cols-4 items-center gap-4",children:[(0,t.jsx)(i.J,{htmlFor:"status",className:"text-right",children:"Estado"}),(0,t.jsxs)("div",{className:"flex items-center space-x-2 col-span-3",children:[(0,t.jsx)(d.d,{id:"status",checked:"Activo"===b.status,onCheckedChange:e=>y({...b,status:e?"Activo":"Inactivo"})}),(0,t.jsx)(i.J,{htmlFor:"status",className:"font-normal",children:b.status})]})]})]}),(0,t.jsxs)(l.Es,{children:[(0,t.jsx)(r.$,{variant:"outline",onClick:S,children:"Cancelar"}),(0,t.jsx)(r.$,{type:"submit",onClick:A,children:"Guardar"})]})]})})}},4884:(e,s,a)=>{"use strict";a.d(s,{bL:()=>y,zi:()=>C});var t=a(2115),n=a(5185),r=a(6101),l=a(6081),i=a(5845),c=a(5503),d=a(1275),o=a(3540),u=a(5155),x="Switch",[h,m]=(0,l.A)(x),[p,j]=h(x),g=t.forwardRef((e,s)=>{let{__scopeSwitch:a,name:l,checked:c,defaultChecked:d,required:x,disabled:h,value:m="on",onCheckedChange:j,form:g,...N}=e,[v,y]=t.useState(null),C=(0,r.s)(s,e=>y(e)),w=t.useRef(!1),k=!v||g||!!v.closest("form"),[_=!1,A]=(0,i.i)({prop:c,defaultProp:d,onChange:j});return(0,u.jsxs)(p,{scope:a,checked:_,disabled:h,children:[(0,u.jsx)(o.sG.button,{type:"button",role:"switch","aria-checked":_,"aria-required":x,"data-state":b(_),"data-disabled":h?"":void 0,disabled:h,value:m,...N,ref:C,onClick:(0,n.m)(e.onClick,e=>{A(e=>!e),k&&(w.current=e.isPropagationStopped(),w.current||e.stopPropagation())})}),k&&(0,u.jsx)(f,{control:v,bubbles:!w.current,name:l,value:m,checked:_,required:x,disabled:h,form:g,style:{transform:"translateX(-100%)"}})]})});g.displayName=x;var N="SwitchThumb",v=t.forwardRef((e,s)=>{let{__scopeSwitch:a,...t}=e,n=j(N,a);return(0,u.jsx)(o.sG.span,{"data-state":b(n.checked),"data-disabled":n.disabled?"":void 0,...t,ref:s})});v.displayName=N;var f=e=>{let{control:s,checked:a,bubbles:n=!0,...r}=e,l=t.useRef(null),i=(0,c.Z)(a),o=(0,d.X)(s);return t.useEffect(()=>{let e=l.current,s=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"checked").set;if(i!==a&&s){let t=new Event("click",{bubbles:n});s.call(e,a),e.dispatchEvent(t)}},[i,a,n]),(0,u.jsx)("input",{type:"checkbox","aria-hidden":!0,defaultChecked:a,...r,tabIndex:-1,ref:l,style:{...e.style,...o,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function b(e){return e?"checked":"unchecked"}var y=g,C=v},7446:(e,s,a)=>{"use strict";a.r(s),a.d(s,{default:()=>z});var t=a(5155),n=a(2115),r=a(3013),l=a(1055),i=a(3638),c=a(7223),d=a(4301),o=a(1920),u=a(172),x=a(4371),h=a(2720),m=a(4956),p=a(9240),j=a(5731),g=a(9434),N=a(1689),v=a(6695),f=a(285),b=a(2523),y=a(5057),C=a(2346),w=a(4636),k=a(5511),_=a(1524),A=a(6102),S=a(4165),E=a(5127),I=a(6424),F=a(6126),P=a(8856),$=a(5074),R=a(5300),q=a(5943);function L(e){let{open:s,onOpenChange:a,onViewReceipt:i,onEditPurchase:c}=e,[d,o]=n.useState([]),[u,h]=n.useState(!1),[m,p]=n.useState(""),g=n.useCallback(()=>{h(!0),(0,j.sf)().then(e=>{o(e)}).catch(()=>{}).finally(()=>h(!1))},[]);n.useEffect(()=>{s&&g()},[s,g]);let v=async e=>{if(window.confirm("\xbfEst\xe1s seguro de que quieres anular esta compra? Esta acci\xf3n no se puede deshacer."))try{await (0,j.E6)({transaction_id:e.transaction_id}),(0,N.tP)("Compra Anulada","La compra ha sido anulada correctamente."),g()}catch(e){}},y=d.filter(e=>{let s=m.toLowerCase();return e.entity_name.toLowerCase().includes(s)||e.document_number&&e.document_number.toLowerCase().includes(s)||e.entity_document&&e.entity_document.toLowerCase().includes(s)});return(0,t.jsx)(S.lG,{open:s,onOpenChange:a,children:(0,t.jsxs)(S.Cf,{className:"max-w-4xl",children:[(0,t.jsxs)(S.c7,{children:[(0,t.jsx)(S.L3,{children:"Historial de Compras"}),(0,t.jsx)(S.rr,{children:"Aqu\xed puedes ver, editar y anular las compras registradas."})]}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)($.A,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),(0,t.jsx)(b.p,{placeholder:"Buscar por proveedor, RIF o factura...",value:m,onChange:e=>p(e.target.value),className:"pl-8"})]}),(0,t.jsx)(I.F,{className:"h-[60vh] pr-6",children:(0,t.jsxs)(E.XI,{children:[(0,t.jsx)(E.A0,{children:(0,t.jsxs)(E.Hj,{children:[(0,t.jsx)(E.nd,{children:"Estado"}),(0,t.jsx)(E.nd,{children:"Fecha"}),(0,t.jsx)(E.nd,{children:"Proveedor"}),(0,t.jsx)(E.nd,{children:"RIF"}),(0,t.jsx)(E.nd,{children:"Factura N\xba"}),(0,t.jsx)(E.nd,{className:"text-right",children:"Total"}),(0,t.jsx)(E.nd,{className:"text-center",children:"Acciones"})]})}),(0,t.jsx)(E.BF,{children:u?Array.from({length:5}).map((e,s)=>(0,t.jsx)(E.Hj,{children:(0,t.jsx)(E.nA,{colSpan:7,children:(0,t.jsx)(P.E,{className:"h-8 w-full"})})},s)):y.length>0?y.map(e=>{let s="Anulado"===e.status;return(0,t.jsxs)(E.Hj,{className:s?"opacity-50":"",children:[(0,t.jsx)(E.nA,{children:s&&(0,t.jsx)(F.E,{variant:"destructive",children:"Anulada"})}),(0,t.jsx)(E.nA,{className:s?"line-through":"",children:(0,r.GP)(new Date(e.transaction_date),"dd/MM/yyyy HH:mm",{locale:l.es})}),(0,t.jsx)(E.nA,{className:s?"line-through":"",children:e.entity_name}),(0,t.jsx)(E.nA,{className:s?"line-through":"",children:e.entity_document}),(0,t.jsx)(E.nA,{className:s?"line-through":"",children:e.document_number}),(0,t.jsxs)(E.nA,{className:"text-right ".concat(s?"line-through":""),children:["$",e.total_cost.toFixed(2)]}),(0,t.jsx)(E.nA,{className:"text-center",children:(0,t.jsx)(A.Bc,{children:(0,t.jsxs)("div",{className:"flex justify-center items-center space-x-1",children:[(0,t.jsxs)(A.m_,{children:[(0,t.jsx)(A.k$,{asChild:!0,children:(0,t.jsx)(f.$,{variant:"ghost",size:"icon",onClick:()=>i(e),children:(0,t.jsx)(R.A,{className:"h-4 w-4"})})}),(0,t.jsx)(A.ZI,{children:(0,t.jsx)("p",{children:"Ver Recibo"})})]}),(0,t.jsxs)(A.m_,{children:[(0,t.jsx)(A.k$,{asChild:!0,children:(0,t.jsx)(f.$,{variant:"ghost",size:"icon",onClick:()=>c(e),disabled:s,children:(0,t.jsx)(q.A,{className:"h-4 w-4"})})}),(0,t.jsx)(A.ZI,{children:(0,t.jsx)("p",{children:"Editar Compra"})})]}),(0,t.jsxs)(A.m_,{children:[(0,t.jsx)(A.k$,{asChild:!0,children:(0,t.jsx)(f.$,{variant:"ghost",size:"icon",onClick:()=>v(e),disabled:s,className:"text-destructive hover:text-destructive",children:(0,t.jsx)(x.A,{className:"h-4 w-4"})})}),(0,t.jsx)(A.ZI,{children:(0,t.jsx)("p",{children:"Anular Compra"})})]})]})})})]},e.transaction_id)}):(0,t.jsx)(E.Hj,{children:(0,t.jsx)(E.nA,{colSpan:7,className:"text-center",children:"No se encontraron compras."})})})]})})]})})}var D=a(8018);function O(){return(0,t.jsxs)("div",{className:"p-4",children:[(0,t.jsxs)("div",{className:"text-center mb-4",children:[(0,t.jsx)(P.E,{className:"h-6 w-3/4 mx-auto"}),(0,t.jsx)(P.E,{className:"h-4 w-full mt-2"}),(0,t.jsx)(P.E,{className:"h-4 w-1/2 mt-1 mx-auto"})]}),(0,t.jsx)(C.w,{className:"my-2 border-dashed"}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(P.E,{className:"h-4 w-full"}),(0,t.jsx)(P.E,{className:"h-4 w-full"}),(0,t.jsx)(P.E,{className:"h-4 w-2/3"})]}),(0,t.jsx)(C.w,{className:"my-2 border-dashed"}),(0,t.jsx)("div",{className:"space-y-2 mt-4",children:Array.from({length:3}).map((e,s)=>(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2",children:[(0,t.jsx)("div",{className:"col-span-6",children:(0,t.jsx)(P.E,{className:"h-4 w-full"})}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:(0,t.jsx)(P.E,{className:"h-4 w-full"})}),(0,t.jsx)("div",{className:"col-span-4 text-right",children:(0,t.jsx)(P.E,{className:"h-4 w-full"})})]},s))}),(0,t.jsx)(C.w,{className:"my-2 border-dashed"}),(0,t.jsxs)("div",{className:"space-y-2 mt-4",children:[(0,t.jsx)(P.E,{className:"h-5 w-1/2 ml-auto"}),(0,t.jsx)(P.E,{className:"h-6 w-1/3 ml-auto mt-2"})]})]})}function J(e){let{open:s,onOpenChange:a,transactionId:i}=e,c=n.useRef(null),{toast:d}=(0,N.dj)(),[o,u]=n.useState({}),[x,h]=n.useState(null),[m,p]=n.useState([]),[g,v]=n.useState(!1),[b,y]=n.useState(null);return console.log("Fetching purchase details for transaction ID:",i),n.useEffect(()=>{s&&i&&(v(!0),y(null),h(null),Promise.all([(0,j.iR)(i),(0,j.d$)(),(0,j.r5)()]).then(e=>{let[s,a,t]=e;h(s),p(a),u(t)}).catch(()=>{y("No se pudieron cargar los detalles del recibo."),d({variant:"destructive",title:"Error",description:"No se pudieron cargar los detalles del recibo."})}).finally(()=>{v(!1)}))},[s,i,d]),(0,t.jsx)(S.lG,{open:s,onOpenChange:a,children:(0,t.jsxs)(S.Cf,{className:"sm:max-w-md",children:[(0,t.jsxs)(S.c7,{children:[(0,t.jsx)(S.L3,{children:"Recibo de Compra"}),(0,t.jsx)(S.rr,{children:"Detalles de la compra registrada. Puedes imprimir este recibo."})]}),(0,t.jsx)(I.F,{className:"max-h-[60vh]",children:(()=>{if(g)return(0,t.jsx)(O,{});if(b)return(0,t.jsx)("div",{className:"p-4 text-center text-red-500",children:b});if(!x)return(0,t.jsx)("div",{className:"p-4 text-center",children:"No hay datos de compra para mostrar."});let e=e=>m.find(s=>s.id===e),s=x.items.reduce((e,s)=>e+s.quantity*s.unitCost,0),a=x.items.reduce((s,a)=>{var t;let n=e(a.productId),r=null!=(t=null==n?void 0:n.tax_rate)?t:0;return s+a.quantity*a.unitCost*(r/100)},0),n=s+a;return(0,t.jsxs)("div",{ref:c,className:"text-sm font-mono p-4",children:[(0,t.jsxs)("div",{className:"text-center mb-4",children:[(0,t.jsx)("h3",{className:"font-bold text-lg",children:o.name||"Mi Tienda"}),(0,t.jsx)("p",{children:o.address||""}),(0,t.jsx)("p",{children:o.phone||""})]}),(0,t.jsx)(C.w,{className:"my-2 border-dashed"}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Factura #:"}),(0,t.jsx)("span",{children:x.document_number||"N/A"})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Fecha:"}),(0,t.jsx)("span",{children:(0,r.GP)(new Date(x.transaction_date),"dd/MM/yyyy HH:mm",{locale:l.es})})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Proveedor:"}),(0,t.jsx)("span",{children:x.entity_name||"N/A"})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"RIF:"}),(0,t.jsx)("span",{children:x.entity_document||"N/A"})]}),(0,t.jsx)(C.w,{className:"my-2 border-dashed"}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2 font-bold",children:[(0,t.jsx)("div",{className:"col-span-6",children:"Producto"}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:"Cant"}),(0,t.jsx)("div",{className:"col-span-4 text-right",children:"Subtotal"})]}),x.items.map((s,a)=>{let n=e(s.productId);return(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2",children:[(0,t.jsx)("div",{className:"col-span-6 truncate",children:(null==n?void 0:n.name)||"N/A"}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:s.quantity}),(0,t.jsx)("div",{className:"col-span-4 text-right",children:(s.quantity*s.unitCost).toFixed(2)})]},"".concat(s.productId,"-").concat(a))})]}),(0,t.jsx)(C.w,{className:"my-2 border-dashed"}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Subtotal:"}),(0,t.jsxs)("span",{children:["$",s.toFixed(2)]})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Impuestos:"}),(0,t.jsxs)("span",{children:["$",a.toFixed(2)]})]}),(0,t.jsxs)("div",{className:"flex justify-between font-bold text-base mt-2",children:[(0,t.jsx)("span",{children:"TOTAL:"}),(0,t.jsxs)("span",{children:["$",n.toFixed(2)]})]})]})})()}),(0,t.jsx)(S.Es,{className:"sm:justify-end gap-2",children:(0,t.jsx)(A.Bc,{children:(0,t.jsxs)(A.m_,{children:[(0,t.jsx)(A.k$,{asChild:!0,children:(0,t.jsx)(f.$,{type:"button",variant:"outline",size:"icon",onClick:()=>{var e;let s=null==(e=c.current)?void 0:e.innerHTML;if(!s)return void d({variant:"destructive",title:"Error de Impresi\xf3n",description:"No se pudo encontrar el contenido del recibo."});let a=window.open("","_blank");a&&(a.document.write("\n        <html>\n            <head>\n            <title>Recibo de Compra</title>\n            <style>\n                body { font-family: 'Courier New', Courier, monospace; margin: 20px; }\n                .receipt-container { width: 300px; margin: 0 auto; }\n                .header { text-align: center; }\n                .item { display: flex; justify-content: space-between; }\n                .total { font-weight: bold; }\n                hr { border: none; border-top: 1px dashed #000; }\n            </style>\n            </head>\n            <body>".concat(s,"</body>\n        </html>")),a.document.close(),a.focus(),a.print(),a.close())},disabled:g||!!b||!x,children:(0,t.jsx)(D.A,{className:"h-4 w-4"})})}),(0,t.jsx)(A.ZI,{children:(0,t.jsx)("p",{children:"Imprimir"})})]})})})]})})}var G=a(5365),M=a(1949);function T(e){let{open:s,onOpenChange:a,purchaseItems:n,onConfirm:r,isSaving:l}=e;if(!n||0===n.length)return null;let i=n.reduce((e,s)=>e+s.quantity*s.unitCost,0);return(0,t.jsx)(S.lG,{open:s,onOpenChange:a,children:(0,t.jsxs)(S.Cf,{className:"max-w-2xl",children:[(0,t.jsxs)(S.c7,{children:[(0,t.jsx)(S.L3,{children:"Confirmar Registro de Compra"}),(0,t.jsx)(S.rr,{children:"Revisa los productos y totales. Esta acci\xf3n registrar\xe1 la entrada en el inventario."})]}),(0,t.jsxs)(G.Fc,{children:[(0,t.jsx)(M.A,{className:"h-4 w-4"}),(0,t.jsx)(G.XL,{children:"\xa1Atenci\xf3n!"}),(0,t.jsx)(G.TN,{children:"Los productos duplicados han sido consolidados en una sola l\xednea."})]}),(0,t.jsx)(I.F,{className:"h-[40vh] pr-6",children:(0,t.jsxs)(E.XI,{children:[(0,t.jsx)(E.A0,{children:(0,t.jsxs)(E.Hj,{children:[(0,t.jsx)(E.nd,{children:"Producto"}),(0,t.jsx)(E.nd,{className:"text-right",children:"Cantidad"}),(0,t.jsx)(E.nd,{className:"text-right",children:"Costo Unitario"}),(0,t.jsx)(E.nd,{className:"text-right",children:"Subtotal"})]})}),(0,t.jsx)(E.BF,{children:n.map(e=>(0,t.jsxs)(E.Hj,{children:[(0,t.jsx)(E.nA,{children:e.productName}),(0,t.jsx)(E.nA,{className:"text-right",children:e.quantity}),(0,t.jsxs)(E.nA,{className:"text-right",children:["$",e.unitCost.toFixed(2)]}),(0,t.jsxs)(E.nA,{className:"text-right",children:["$",(e.quantity*e.unitCost).toFixed(2)]})]},e.productId))})]})}),(0,t.jsxs)("div",{className:"text-right font-bold text-lg pr-6",children:["Total de la Compra: $",i.toFixed(2)]}),(0,t.jsxs)(S.Es,{children:[(0,t.jsx)(f.$,{variant:"outline",onClick:()=>a(!1),disabled:l,children:"Cancelar"}),(0,t.jsx)(f.$,{onClick:r,disabled:l,children:l?"Guardando...":"Confirmar y Guardar"})]})]})})}var Z=a(1475);let H=()=>({id:"temp-".concat(Date.now(),"-").concat(Math.random()),productId:null,name:"",quantity:1,unitCost:0,tax_rate:0});function z(){let[e,s]=n.useState(new Date),[a,S]=n.useState(""),[E,I]=n.useState(""),[F,P]=n.useState(""),[$,R]=n.useState([]),[q,D]=n.useState([H()]),[O,G]=n.useState(!1),[M,z]=n.useState(!0),[B,K]=n.useState(null),[W,V]=n.useState([]),[X,U]=n.useState(!1),[Q,Y]=n.useState(!1),[ee,es]=n.useState(!1),[ea,et]=n.useState([]),[en,er]=n.useState(null),[el,ei]=n.useState(null),[ec,ed]=n.useState(!1),[eo,eu]=n.useState(null),[ex,eh]=n.useState({}),{isBackendReady:em,refetchKey:ep,triggerRefetch:ej}=(0,p.useBackendStatus)();n.useEffect(()=>{em&&(async()=>{z(!0);try{let{activeStoreId:e}=await (0,j.Dv)(),[s,a,t]=await Promise.all([(0,j.d$)(),(0,j.GZ)(e),(0,j.DQ)()]);R(s),eh(a||{}),V(t.purchases||[])}catch(e){}finally{z(!1)}})()},[em,ep]);let eg=n.useMemo(()=>new Map($.map(e=>[e.id,e])),[$]),eN=n.useMemo(()=>{var e;let s=(null==(e=ex.advanced)?void 0:e.showInactiveProducts)||!1;return $.filter(e=>s||"Activo"===e.status).map(e=>({value:String(e.id),label:"(".concat(e.sku||"N/A",") ").concat(e.name)}))},[$,ex]),ev=()=>{s(new Date),S(""),I(""),P(""),D([H()]),K(null),ei(null)},ef=(e,s,a)=>{let t=[...q],n=t[e];if("productId"===s){let e=eg.get(Number(a));e&&(n.productId=e.id,n.name=e.name,n.unitCost=e.price,n.tax_rate=e.tax_rate)}else n[s]=Number(a);D(t)},eb=e=>{D(q.filter((s,a)=>a!==e))},ey=async()=>{G(!0);let s={transaction_date:e.toISOString(),entity_name:a||void 0,entity_document:E||void 0,document_number:F||void 0,items:ea.map(e=>{let{productName:s,...a}=e;return a})};try{if(el)await (0,j.dF)({transaction_id:el,purchaseData:s}),(0,N.tP)("Compra Actualizada","La compra se ha modificado exitosamente."),er(el),Y(!0);else{let e=await (0,j.aL)(s);(0,N.tP)("Compra Registrada","La compra se ha guardado exitosamente."),er(e.transaction_id),Y(!0)}ej(),ev(),U(!1)}catch(e){}finally{G(!1),es(!1)}},eC=async()=>{if(q.every(e=>null===e.productId))return void(0,N.Kf)("Compra Vac\xeda","No puedes poner en espera una compra sin productos.");let s={id:"pending-".concat(Date.now()),cart:q,date:e,supplier:a,supplierRif:E,invoiceNumber:F,createdAt:new Date};try{await (0,j.xs)("purchase",s),(0,N.tP)("Compra en Espera","La compra actual se ha guardado."),ev(),ej()}catch(e){}},ew=async e=>{let a=new Date(e.date),t=!isNaN(a.getTime()),n=new Set($.map(e=>e.id)),r=e.cart.filter(e=>e.productId&&n.has(e.productId)),l=e.cart.filter(e=>!e.productId||!n.has(e.productId));if(l.length>0){let e=l.map(e=>e.name||"ID ".concat(e.productId)).join(", ");(0,N.Kf)("".concat(l.length," Producto(s) no Encontrado(s)"),"Omitidos: ".concat(e))}D(r.length>0?r:[H()]),s(t?a:new Date),S(e.supplier),I(e.supplierRif),P(e.invoiceNumber);try{await (0,j.Kq)(e.id),(0,N.tP)("Compra Restaurada","La compra ha sido cargada en el formulario."),ej()}catch(e){}},ek=async e=>{try{await (0,j.Kq)(e),(0,N.tP)("Compra Descartada","La compra en espera ha sido eliminada."),ej()}catch(e){}},e_=q.reduce((e,s)=>e+s.quantity*s.unitCost,0),eA=q.reduce((e,s)=>e+s.quantity*s.unitCost*(s.tax_rate/100),0),eS=e_+eA,eE=q.some(e=>!e.productId||e.quantity<=0)||O,eI=()=>(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-4 px-3 py-2 text-xs font-semibold text-muted-foreground bg-muted",children:[(0,t.jsx)("div",{className:"col-span-2 text-center",children:"C\xf3digo"}),(0,t.jsx)("div",{className:"col-span-4 text-center",children:"Producto"}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:"Stock"}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:"Costo"}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:"IVA"})]}),eF=e=>{let s=eg.get(Number(e.value));return s?(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-4 w-full text-sm",children:[(0,t.jsx)("div",{className:"col-span-2 font-mono text-xs text-center",children:s.sku||"N/A"}),(0,t.jsx)("div",{className:"col-span-4 truncate",title:s.name,children:s.name}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:s.stock}),(0,t.jsxs)("div",{className:"col-span-2 text-right",children:["$",s.price.toFixed(2)]}),(0,t.jsxs)("div",{className:"col-span-2 text-right",children:[s.tax_rate.toFixed(2),"%"]})]}):(0,t.jsx)("div",{children:e.label})};return(0,t.jsxs)(A.Bc,{children:[(0,t.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("h1",{className:"font-semibold text-lg md:text-2xl",children:"Compras"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:el?"Editando compra a ".concat(a):"Registra nuevas \xf3rdenes de compra."})]}),(0,t.jsxs)(f.$,{variant:"outline",onClick:()=>U(!0),disabled:null!==el,children:[(0,t.jsx)(i.A,{className:"mr-2 h-4 w-4"}),"Historial"]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8 items-start",children:[(0,t.jsx)("div",{className:"lg:col-span-2 space-y-6",children:(0,t.jsxs)(v.Zp,{children:[(0,t.jsx)(v.aR,{children:(0,t.jsx)(v.ZB,{children:el?"Editar Orden de Compra":"Nueva Orden de Compra"})}),(0,t.jsx)(v.Wu,{children:(0,t.jsxs)("div",{className:"grid gap-6",children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(y.J,{htmlFor:"supplier",children:"Proveedor"}),(0,t.jsx)(b.p,{id:"supplier",value:a,onChange:e=>S(e.target.value),placeholder:"Nombre del proveedor"})]}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(y.J,{htmlFor:"supplierRif",children:"RIF Proveedor"}),(0,t.jsx)(b.p,{id:"supplierRif",value:E,onChange:e=>I(e.target.value),placeholder:"Ej: J-12345678"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2 items-center mb-2 px-1",children:[(0,t.jsx)("div",{className:"col-span-12 md:col-span-6",children:(0,t.jsx)(y.J,{className:"text-sm font-medium",children:"Producto"})}),(0,t.jsx)("div",{className:"col-span-4 md:col-span-2",children:(0,t.jsx)(y.J,{className:"text-sm font-medium",children:"Cantidad"})}),(0,t.jsx)("div",{className:"col-span-4 md:col-span-2",children:(0,t.jsx)(y.J,{className:"text-sm font-medium",children:"Costo Unit."})}),(0,t.jsx)("div",{className:"col-span-4 md:col-span-2",children:(0,t.jsx)(y.J,{className:"text-sm font-medium text-right w-full pr-2",children:"Acci\xf3n"})})]}),(0,t.jsx)("div",{className:"grid gap-4 border p-4 rounded-md",children:q.map((e,s)=>(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2 items-end",children:[(0,t.jsx)("div",{className:"col-span-12 md:col-span-6",children:(0,t.jsx)(_.G,{open:B===s,onOpenChange:e=>K(e?s:null),options:eN,value:e.productId?String(e.productId):"",onChange:e=>{ef(s,"productId",e),K(null)},placeholder:M?"Cargando...":"Seleccionar...",searchPlaceholder:"Buscar por c\xf3digo o nombre...",emptyMessage:"No hay productos.",disabled:M,popoverClassName:"w-[700px]",align:"start",sideOffset:10,renderHeader:eI,renderOption:eF})}),(0,t.jsx)("div",{className:"col-span-4 md:col-span-2",children:(0,t.jsx)(b.p,{type:"number",value:e.quantity,onChange:e=>ef(s,"quantity",e.target.value),min:"1"})}),(0,t.jsx)("div",{className:"col-span-4 md:col-span-2",children:(0,t.jsx)(b.p,{type:"number",value:e.unitCost,onChange:e=>ef(s,"unitCost",e.target.value),min:"0"})}),(0,t.jsx)("div",{className:"col-span-4 md:col-span-2 flex justify-end",children:(0,t.jsx)(f.$,{variant:"outline",size:"icon",className:"text-muted-foreground",onClick:()=>eb(s),disabled:q.length<=1,children:(0,t.jsx)(c.A,{className:"h-4 w-4"})})})]},e.id))}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-4",children:[(0,t.jsxs)(f.$,{size:"sm",className:"gap-1",onClick:()=>{D(e=>[...e,H()]),K(q.length)},children:[(0,t.jsx)(d.A,{className:"h-3.5 w-3.5"}),"A\xf1adir Producto"]}),(0,t.jsxs)(f.$,{variant:"outline",size:"sm",className:"gap-1",onClick:()=>{eu({name:"",price:0,stock:0,status:"Activo",sku:0===$.length?"1":($.reduce((e,s)=>{let a=parseInt(s.sku||"0",10);return!isNaN(a)&&a>e?a:e},0)+1).toString()}),ed(!0)},children:[(0,t.jsx)(d.A,{className:"h-3.5 w-3.5"}),"Crear Producto"]})]})]})]})})]})}),(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)(v.Zp,{children:[(0,t.jsx)(v.aR,{children:(0,t.jsx)(v.ZB,{children:"Configuraci\xf3n"})}),(0,t.jsxs)(v.Wu,{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(y.J,{children:"Fecha de Compra"}),(0,t.jsxs)(w.AM,{children:[(0,t.jsx)(w.Wv,{asChild:!0,children:(0,t.jsxs)(f.$,{variant:"outline",className:(0,g.cn)("w-full justify-start text-left font-normal",!e&&"text-muted-foreground"),children:[(0,t.jsx)(o.A,{className:"mr-2 h-4 w-4"}),e?(0,r.GP)(e,"PPP",{locale:l.es}):(0,t.jsx)("span",{children:"Seleccione fecha"})]})}),(0,t.jsx)(w.hl,{className:"w-auto p-0",children:(0,t.jsx)(k.V,{mode:"single",selected:e,onSelect:e=>s(e||new Date),initialFocus:!0})})]})]}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(y.J,{htmlFor:"invoiceNumber",children:"N\xba de Factura"}),(0,t.jsx)(b.p,{id:"invoiceNumber",value:F,onChange:e=>P(e.target.value),placeholder:"Opcional"})]})]})]}),(0,t.jsxs)(v.Zp,{children:[(0,t.jsx)(v.aR,{children:(0,t.jsx)(v.ZB,{children:"Resumen de Compra"})}),(0,t.jsxs)(v.Wu,{className:"grid gap-4",children:[(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Subtotal"}),(0,t.jsxs)("span",{children:["$",e_.toFixed(2)]})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Impuestos"}),(0,t.jsxs)("span",{children:["$",eA.toFixed(2)]})]}),(0,t.jsx)(C.w,{}),(0,t.jsxs)("div",{className:"flex justify-between font-semibold text-lg",children:[(0,t.jsx)("span",{children:"Total"}),(0,t.jsxs)("span",{children:["$",eS.toFixed(2)]})]})]})]}),(0,t.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,t.jsxs)(f.$,{onClick:()=>{let e=new Map;q.filter(e=>null!==e.productId).forEach(s=>{let a=s.productId;if(e.has(a)){let t=e.get(a);t.quantity+=s.quantity}else e.set(a,{productId:a,productName:s.name,quantity:s.quantity,unitCost:s.unitCost})}),et(Array.from(e.values())),es(!0)},disabled:eE,size:"lg",children:[O&&(0,t.jsx)(u.A,{className:"mr-2 h-4 w-4 animate-spin"}),O?"Procesando...":el?"Guardar Cambios":"Registrar Compra"]}),el&&(0,t.jsxs)(f.$,{variant:"ghost",onClick:ev,children:[(0,t.jsx)(x.A,{className:"mr-2 h-4 w-4"}),"Cancelar Edici\xf3n"]}),(0,t.jsx)(f.$,{variant:"secondary",onClick:eC,disabled:null!==el,children:"Poner en Espera"})]}),W.length>0&&(0,t.jsxs)(v.Zp,{children:[(0,t.jsxs)(v.aR,{children:[(0,t.jsx)(v.ZB,{children:"Compras en Espera"}),(0,t.jsx)(v.BT,{children:"Restaura o elimina las compras pendientes."})]}),(0,t.jsx)(v.Wu,{className:"space-y-4",children:W.map(e=>(0,t.jsxs)("div",{className:"flex items-center justify-between p-2 border rounded-lg",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-medium",children:e.supplier||"Proveedor General"}),(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:[e.cart.length," producto(s) - ",(0,r.GP)(new Date(e.createdAt),"p",{locale:l.es})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)(A.m_,{children:[(0,t.jsx)(A.k$,{asChild:!0,children:(0,t.jsx)(f.$,{variant:"outline",size:"icon",onClick:()=>ew(e),children:(0,t.jsx)(h.A,{className:"h-4 w-4"})})}),(0,t.jsx)(A.ZI,{children:(0,t.jsx)("p",{children:"Restaurar"})})]}),(0,t.jsxs)(A.m_,{children:[(0,t.jsx)(A.k$,{asChild:!0,children:(0,t.jsx)(f.$,{variant:"destructive",size:"icon",onClick:()=>ek(e.id),children:(0,t.jsx)(m.A,{className:"h-4 w-4"})})}),(0,t.jsx)(A.ZI,{children:(0,t.jsx)("p",{children:"Eliminar"})})]})]})]},e.id))})]})]})]})]}),(0,t.jsx)(Z.E,{open:ec,onOpenChange:ed,product:eo,onProductSaved:e=>{var s,a;R(s=>[...s,e]);let t=[...q],n=t.findIndex(e=>null===e.productId),r={id:"temp-".concat(Date.now()),productId:e.id,name:e.name,quantity:1,unitCost:null!=(s=e.price)?s:0,tax_rate:null!=(a=e.tax_rate)?a:0};-1!==n?(t[n]=r,D(t)):D(e=>[...e,r]),(0,N.tP)("Producto Guardado",'El producto "'.concat(e.name,'" ha sido a\xf1adido a la compra.')),ed(!1),ej()}}),(0,t.jsx)(L,{open:X,onOpenChange:U,onViewReceipt:e=>{er(e.transaction_id),Y(!0)},onEditPurchase:e=>{s(new Date(e.transaction_date)),S(e.entity_name),I("N/A"!==e.entity_document?e.entity_document:""),P(e.document_number);let a=new Map;e.movements.forEach(e=>{let s=eg.get(e.productId);if(a.has(e.productId)){let s=a.get(e.productId);s.quantity+=e.quantity}else a.set(e.productId,{id:"edit-consolidated-".concat(e.productId),productId:e.productId,name:e.productName,quantity:e.quantity,unitCost:e.unit_cost,tax_rate:(null==s?void 0:s.tax_rate)||0})}),D(Array.from(a.values())),ei(e.transaction_id),U(!1)}}),(0,t.jsx)(J,{open:Q,onOpenChange:e=>{console.log("Receipt dialog, open:",e),console.log("Selected transaction ID:",en),e||er(null),Y(e)},transactionId:en}),(0,t.jsx)(T,{open:ee,onOpenChange:es,purchaseItems:ea,onConfirm:ey,isSaving:O})]})}},8539:(e,s,a)=>{"use strict";a.d(s,{T:()=>l});var t=a(5155),n=a(2115),r=a(9434);let l=n.forwardRef((e,s)=>{let{className:a,...n}=e;return(0,t.jsx)("textarea",{className:(0,r.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",a),ref:s,...n})});l.displayName="Textarea"}},e=>{var s=s=>e(e.s=s);e.O(0,[130,134,131,748,655,841,240,86,441,684,358],()=>s(1464)),_N_E=e.O()}]);
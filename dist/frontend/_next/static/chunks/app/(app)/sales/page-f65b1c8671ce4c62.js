(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[732],{1986:(e,s,a)=>{"use strict";a.d(s,{d:()=>N});var t=a(5155),n=a(2115),l=a(4165),i=a(285),c=a(2346),r=a(6424),d=a(1689),o=a(5731),x=a(3013),h=a(1055),m=a(6102),u=a(8018),j=a(8856);function p(){return(0,t.jsxs)("div",{className:"p-4",children:[(0,t.jsxs)("div",{className:"text-center mb-4",children:[(0,t.jsx)(j.E,{className:"h-6 w-3/4 mx-auto"}),(0,t.jsx)(j.E,{className:"h-4 w-full mt-2"}),(0,t.jsx)(j.E,{className:"h-4 w-1/2 mt-1 mx-auto"})]}),(0,t.jsx)(c.w,{className:"my-2 border-dashed"}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(j.E,{className:"h-4 w-full"}),(0,t.jsx)(j.E,{className:"h-4 w-full"}),(0,t.jsx)(j.E,{className:"h-4 w-2/3"})]}),(0,t.jsx)(c.w,{className:"my-2 border-dashed"}),(0,t.jsx)("div",{className:"space-y-2 mt-4",children:Array.from({length:3}).map((e,s)=>(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2",children:[(0,t.jsx)("div",{className:"col-span-6",children:(0,t.jsx)(j.E,{className:"h-4 w-full"})}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:(0,t.jsx)(j.E,{className:"h-4 w-full"})}),(0,t.jsx)("div",{className:"col-span-4 text-right",children:(0,t.jsx)(j.E,{className:"h-4 w-full"})})]},s))}),(0,t.jsx)(c.w,{className:"my-2 border-dashed"}),(0,t.jsxs)("div",{className:"space-y-2 mt-4",children:[(0,t.jsx)(j.E,{className:"h-5 w-1/2 ml-auto"}),(0,t.jsx)(j.E,{className:"h-6 w-1/3 ml-auto mt-2"})]})]})}function N(e){let{open:s,onOpenChange:a,transactionId:j}=e,N=n.useRef(null),{toast:v}=(0,d.dj)(),[g,f]=n.useState({}),[y,b]=n.useState(null),[w,C]=n.useState([]),[S,A]=n.useState(!1),[k,I]=n.useState(null);return n.useEffect(()=>{s&&j&&(A(!0),I(null),b(null),Promise.all([(0,o.oG)(j),(0,o.d$)(),(0,o.r5)()]).then(e=>{let[s,a,t]=e;b(s),C(a),f(t)}).catch(()=>{I("No se pudieron cargar los detalles del recibo."),v({variant:"destructive",title:"Error",description:"No se pudieron cargar los detalles del recibo."})}).finally(()=>{A(!1)}))},[s,j,v]),(0,t.jsx)(l.lG,{open:s,onOpenChange:a,children:(0,t.jsxs)(l.Cf,{className:"sm:max-w-md",children:[(0,t.jsxs)(l.c7,{children:[(0,t.jsx)(l.L3,{children:"Recibo de Venta"}),(0,t.jsx)(l.rr,{children:"Detalles de la venta registrada. Puedes imprimir este recibo."})]}),(0,t.jsx)(r.F,{className:"max-h-[60vh]",children:(()=>{if(S)return(0,t.jsx)(p,{});if(k)return(0,t.jsx)("div",{className:"p-4 text-center text-red-500",children:k});if(!y)return(0,t.jsx)("div",{className:"p-4 text-center",children:"No hay datos de venta para mostrar."});let e=e=>w.find(s=>s.id===e),s=y.items.reduce((e,s)=>e+s.quantity*s.unitPrice,0),a=y.items.reduce((e,s)=>e+s.quantity*s.unitPrice*(s.tax_rate/100),0),n=s+a;return(0,t.jsxs)("div",{ref:N,className:"text-sm font-mono p-4",children:[(0,t.jsxs)("div",{className:"text-center mb-4",children:[(0,t.jsx)("h3",{className:"font-bold text-lg",children:g.name||"Mi Tienda"}),(0,t.jsx)("p",{children:g.address||""}),(0,t.jsx)("p",{children:g.phone||""})]}),(0,t.jsx)(c.w,{className:"my-2 border-dashed"}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Factura #:"}),(0,t.jsx)("span",{children:y.document_number||"N/A"})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Fecha:"}),(0,t.jsx)("span",{children:(0,x.GP)(new Date(y.transaction_date),"dd/MM/yyyy HH:mm",{locale:h.es})})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Cliente:"}),(0,t.jsx)("span",{children:y.entity_name||"N/A"})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"DNI/RIF:"}),(0,t.jsx)("span",{children:y.entity_document||"N/A"})]}),(0,t.jsx)(c.w,{className:"my-2 border-dashed"}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2 font-bold",children:[(0,t.jsx)("div",{className:"col-span-6",children:"Producto"}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:"Cant"}),(0,t.jsx)("div",{className:"col-span-4 text-right",children:"Subtotal"})]}),y.items.map((s,a)=>{let n=e(s.productId);return(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2",children:[(0,t.jsx)("div",{className:"col-span-6 truncate",children:(null==n?void 0:n.name)||"N/A"}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:s.quantity}),(0,t.jsx)("div",{className:"col-span-4 text-right",children:(s.quantity*s.unitPrice).toFixed(2)})]},"".concat(s.productId,"-").concat(a))})]}),(0,t.jsx)(c.w,{className:"my-2 border-dashed"}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Subtotal:"}),(0,t.jsxs)("span",{children:["$",s.toFixed(2)]})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Impuestos:"}),(0,t.jsxs)("span",{children:["$",a.toFixed(2)]})]}),(0,t.jsxs)("div",{className:"flex justify-between font-bold text-base mt-2",children:[(0,t.jsx)("span",{children:"TOTAL:"}),(0,t.jsxs)("span",{children:["$",n.toFixed(2)]})]})]})})()}),(0,t.jsx)(l.Es,{className:"sm:justify-end gap-2",children:(0,t.jsx)(m.Bc,{children:(0,t.jsxs)(m.m_,{children:[(0,t.jsx)(m.k$,{asChild:!0,children:(0,t.jsx)(i.$,{type:"button",variant:"outline",size:"icon",onClick:()=>{var e;let s=null==(e=N.current)?void 0:e.innerHTML;if(!s)return void v({variant:"destructive",title:"Error de Impresi\xf3n",description:"No se pudo encontrar el contenido del recibo."});let a=window.open("","_blank");a&&(a.document.write("\n        <html>\n            <head>\n            <title>Recibo de Venta</title>\n            <style>\n                body { font-family: 'Courier New', Courier, monospace; margin: 20px; }\n                .receipt-container { width: 300px; margin: 0 auto; }\n                .header { text-align: center; }\n                .item { display: flex; justify-content: space-between; }\n                .total { font-weight: bold; }\n                hr { border: none; border-top: 1px dashed #000; }\n            </style>\n            </head>\n            <body>".concat(s,"</body>\n        </html>")),a.document.close(),a.focus(),a.print(),a.close())},disabled:S||!!k||!y,children:(0,t.jsx)(u.A,{className:"h-4 w-4"})})}),(0,t.jsx)(m.ZI,{children:(0,t.jsx)("p",{children:"Imprimir"})})]})})})]})})}},2948:(e,s,a)=>{Promise.resolve().then(a.bind(a,9685))},9685:(e,s,a)=>{"use strict";a.r(s),a.d(s,{default:()=>Z});var t=a(5155),n=a(2115),l=a(3013),i=a(1055),c=a(3638),r=a(7223),d=a(4301),o=a(1920),x=a(172),h=a(4371),m=a(2720),u=a(4956),j=a(9240),p=a(5731),N=a(9434),v=a(1689),g=a(6695),f=a(285),y=a(2523),b=a(5057),w=a(2346),C=a(4636),S=a(5511),A=a(1524),k=a(6102),I=a(4165),_=a(5127),E=a(6424),P=a(6126),$=a(8856),F=a(5074),q=a(5300),V=a(5943);function D(e){let{open:s,onOpenChange:a,onViewReceipt:c,onEditSale:r,refetchKey:d}=e,[o,x]=n.useState([]),[m,u]=n.useState(!1),[j,N]=n.useState(""),g=n.useCallback(()=>{u(!0),(0,p.rU)().then(e=>{x(e)}).catch(()=>{}).finally(()=>u(!1))},[]);n.useEffect(()=>{s&&g()},[s,g,d]);let b=async e=>{if(window.confirm("\xbfEst\xe1s seguro de que quieres anular esta venta? El stock de los productos se restaurar\xe1."))try{await (0,p.qL)({transaction_id:e.transaction_id}),(0,v.tP)("Venta Anulada","La venta ha sido anulada correctamente."),g()}catch(e){}},w=o.filter(e=>{let s=j.toLowerCase(),a=e.entity_name||"",t=e.document_number||"";return a.toLowerCase().includes(s)||t.toLowerCase().includes(s)});return(0,t.jsx)(I.lG,{open:s,onOpenChange:a,children:(0,t.jsxs)(I.Cf,{className:"max-w-4xl",children:[(0,t.jsxs)(I.c7,{children:[(0,t.jsx)(I.L3,{children:"Historial de Ventas"}),(0,t.jsx)(I.rr,{children:"Aqu\xed puedes ver, editar y anular las ventas registradas."})]}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(F.A,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),(0,t.jsx)(y.p,{placeholder:"Buscar por cliente o factura...",value:j,onChange:e=>N(e.target.value),className:"pl-8"})]}),(0,t.jsx)(E.F,{className:"h-[60vh] pr-6",children:(0,t.jsxs)(_.XI,{children:[(0,t.jsx)(_.A0,{children:(0,t.jsxs)(_.Hj,{children:[(0,t.jsx)(_.nd,{children:"Estado"}),(0,t.jsx)(_.nd,{children:"Fecha"}),(0,t.jsx)(_.nd,{children:"Cliente"}),(0,t.jsx)(_.nd,{children:"Factura N\xba"}),(0,t.jsx)(_.nd,{className:"text-right",children:"Total"}),(0,t.jsx)(_.nd,{className:"text-center",children:"Acciones"})]})}),(0,t.jsx)(_.BF,{children:m?Array.from({length:5}).map((e,s)=>(0,t.jsx)(_.Hj,{children:(0,t.jsx)(_.nA,{colSpan:6,children:(0,t.jsx)($.E,{className:"h-8 w-full"})})},s)):w.length>0?w.map(e=>{let s="Anulado"===e.status;return(0,t.jsxs)(_.Hj,{className:s?"opacity-50":"",children:[(0,t.jsx)(_.nA,{children:s&&(0,t.jsx)(P.E,{variant:"destructive",children:"Anulada"})}),(0,t.jsx)(_.nA,{className:s?"line-through":"",children:(0,l.GP)(new Date(e.transaction_date),"dd/MM/yyyy HH:mm",{locale:i.es})}),(0,t.jsx)(_.nA,{className:s?"line-through":"",children:e.entity_name}),(0,t.jsx)(_.nA,{className:s?"line-through":"",children:e.document_number}),(0,t.jsxs)(_.nA,{className:"text-right ".concat(s?"line-through":""),children:["$",e.total.toFixed(2)]}),(0,t.jsx)(_.nA,{className:"text-center",children:(0,t.jsx)(k.Bc,{children:(0,t.jsxs)("div",{className:"flex justify-center items-center space-x-1",children:[(0,t.jsxs)(k.m_,{children:[(0,t.jsx)(k.k$,{asChild:!0,children:(0,t.jsx)(f.$,{variant:"ghost",size:"icon",onClick:()=>c(e),children:(0,t.jsx)(q.A,{className:"h-4 w-4"})})}),(0,t.jsx)(k.ZI,{children:(0,t.jsx)("p",{children:"Ver Recibo"})})]}),(0,t.jsxs)(k.m_,{children:[(0,t.jsx)(k.k$,{asChild:!0,children:(0,t.jsx)(f.$,{variant:"ghost",size:"icon",onClick:()=>r(e),disabled:s,children:(0,t.jsx)(V.A,{className:"h-4 w-4"})})}),(0,t.jsx)(k.ZI,{children:(0,t.jsx)("p",{children:"Editar Venta"})})]}),(0,t.jsxs)(k.m_,{children:[(0,t.jsx)(k.k$,{asChild:!0,children:(0,t.jsx)(f.$,{variant:"ghost",size:"icon",onClick:()=>b(e),disabled:s,className:"text-destructive hover:text-destructive",children:(0,t.jsx)(h.A,{className:"h-4 w-4"})})}),(0,t.jsx)(k.ZI,{children:(0,t.jsx)("p",{children:"Anular Venta"})})]})]})})})]},e.transaction_id)}):(0,t.jsx)(_.Hj,{children:(0,t.jsx)(_.nA,{colSpan:6,className:"text-center",children:"No se encontraron ventas."})})})]})})]})})}var L=a(1986),R=a(5365),M=a(1949);function G(e){let{open:s,onOpenChange:a,saleItems:n,onConfirm:l,isSaving:i}=e;if(!n||0===n.length)return null;let c=n.reduce((e,s)=>e+s.quantity*s.unitPrice,0),r=n.reduce((e,s)=>e+s.quantity*s.unitPrice*(s.tax_rate/100),0),d=c+r;return(0,t.jsx)(I.lG,{open:s,onOpenChange:a,children:(0,t.jsxs)(I.Cf,{className:"max-w-2xl",children:[(0,t.jsxs)(I.c7,{children:[(0,t.jsx)(I.L3,{children:"Confirmar Registro de Venta"}),(0,t.jsx)(I.rr,{children:"Revisa los productos y totales. Esta acci\xf3n descontar\xe1 el stock del inventario."})]}),(0,t.jsxs)(R.Fc,{children:[(0,t.jsx)(M.A,{className:"h-4 w-4"}),(0,t.jsx)(R.XL,{children:"\xa1Atenci\xf3n!"}),(0,t.jsx)(R.TN,{children:"Los productos duplicados en el carrito han sido consolidados en una sola l\xednea."})]}),(0,t.jsx)(E.F,{className:"h-[40vh] pr-6",children:(0,t.jsxs)(_.XI,{children:[(0,t.jsx)(_.A0,{children:(0,t.jsxs)(_.Hj,{children:[(0,t.jsx)(_.nd,{children:"Producto"}),(0,t.jsx)(_.nd,{className:"text-right",children:"Cantidad"}),(0,t.jsx)(_.nd,{className:"text-right",children:"Precio Unitario"}),(0,t.jsx)(_.nd,{className:"text-right",children:"Subtotal"})]})}),(0,t.jsx)(_.BF,{children:n.map(e=>(0,t.jsxs)(_.Hj,{children:[(0,t.jsx)(_.nA,{children:e.name}),(0,t.jsx)(_.nA,{className:"text-right",children:e.quantity}),(0,t.jsxs)(_.nA,{className:"text-right",children:["$",e.unitPrice.toFixed(2)]}),(0,t.jsxs)(_.nA,{className:"text-right",children:["$",(e.quantity*e.unitPrice).toFixed(2)]})]},e.productId))})]})}),(0,t.jsxs)("div",{className:"grid gap-2 pr-6 text-right",children:[(0,t.jsxs)("div",{className:"flex justify-end gap-4",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Subtotal:"}),(0,t.jsxs)("span",{className:"font-medium w-24",children:["$",c.toFixed(2)]})]}),(0,t.jsxs)("div",{className:"flex justify-end gap-4",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Impuestos:"}),(0,t.jsxs)("span",{className:"font-medium w-24",children:["$",r.toFixed(2)]})]}),(0,t.jsx)(w.w,{}),(0,t.jsxs)("div",{className:"flex justify-end gap-4 font-bold text-lg",children:[(0,t.jsx)("span",{children:"Total:"}),(0,t.jsxs)("span",{className:"w-24",children:["$",d.toFixed(2)]})]})]}),(0,t.jsxs)(I.Es,{children:[(0,t.jsx)(f.$,{variant:"outline",onClick:()=>a(!1),disabled:i,children:"Cancelar"}),(0,t.jsx)(f.$,{onClick:l,disabled:i,children:i?"Guardando...":"Confirmar y Guardar Venta"})]})]})})}let O=()=>({id:"temp-".concat(Date.now(),"-").concat(Math.random()),productId:null,name:"",quantity:1,price:0,tax_rate:0,availableStock:0});function Z(){var e;let[s,a]=n.useState(new Date),[I,_]=n.useState(""),[E,P]=n.useState(""),[$,F]=n.useState(""),[q,V]=n.useState([]),[R,M]=n.useState([O()]),[Z,H]=n.useState(!1),[B,z]=n.useState(!0),[T,J]=n.useState(null),[W,K]=n.useState([]),[Q,U]=n.useState(!1),[X,Y]=n.useState(!1),[ee,es]=n.useState(!1),[ea,et]=n.useState([]),[en,el]=n.useState(null),[ei,ec]=n.useState(null),[er,ed]=n.useState({}),{isBackendReady:eo,refetchKey:ex,triggerRefetch:eh}=(0,j.useBackendStatus)();n.useEffect(()=>{eo&&(async()=>{z(!0);try{let{activeStoreId:e}=await (0,p.Dv)(),[s,a,t]=await Promise.all([(0,p.d$)(),(0,p.GZ)(e),(0,p.DQ)()]);console.log("[SALES PAGE] Fetched store settings:",a),V(s),ed(a||{}),K(t.sales||[])}catch(e){console.error("Error fetching initial sales data:",e)}finally{z(!1)}})()},[eo,ex]);let em=n.useMemo(()=>new Map(q.map(e=>[e.id,e])),[q]),eu=n.useMemo(()=>{var e;let s=new Map,a=(null==(e=er.advanced)?void 0:e.showOutOfStockProducts)||!1;return q.filter(e=>!!a||e.stock>0).forEach(e=>s.set(String(e.id),{value:String(e.id),label:"(".concat(e.sku||"N/A",") ").concat(e.name)})),R.forEach(e=>{if(e.productId&&!s.has(String(e.productId))){let a=em.get(e.productId);a&&s.set(String(a.id),{value:String(a.id),label:"(".concat(a.sku||"N/A",") ").concat(a.name)})}}),Array.from(s.values())},[q,R,em,er]),ej=()=>{a(new Date),_(""),P(""),F(""),M([O()]),J(null),ec(null)},ep=(e,s,a)=>{let t=[...R],n=t[e];if("productId"===s){let e=em.get(Number(a));e&&(n.productId=e.id,n.name=e.name,n.price=e.price,n.tax_rate=e.tax_rate,n.availableStock=e.stock)}else n[s]=Number(a);M(t)},eN=e=>{M(R.filter((s,a)=>a!==e))},ev=async()=>{H(!0);let e={transaction_date:s.toISOString(),entity_name:I||void 0,entity_document:E||void 0,document_number:$||void 0,items:ea};try{if(ei)await (0,p.zw)({transaction_id:ei,saleData:e}),(0,v.tP)("Venta Actualizada","La venta se ha modificado exitosamente."),el(ei),Y(!0);else{let s=await (0,p.M6)(e);(0,v.tP)("Venta Registrada","La venta se ha guardado exitosamente."),el(s.transaction_id),Y(!0)}eh(),ej(),U(!1)}catch(e){}finally{H(!1),es(!1)}},eg=async()=>{if(R.every(e=>null===e.productId))return void(0,v.Kf)("Venta Vac\xeda","No puedes poner en espera una venta sin productos.");let e={id:"pending-".concat(Date.now()),cart:R,date:s,clientName:I,clientDni:E,invoiceNumber:$,createdAt:new Date};try{await (0,p.xs)("sale",e),(0,v.tP)("Venta en Espera","La venta actual se ha guardado."),ej(),eh()}catch(e){}},ef=async e=>{M(e.cart),a(new Date(e.date)),_(e.clientName),P(e.clientDni),F(e.invoiceNumber);try{await (0,p.Kq)(e.id),(0,v.tP)("Venta Restaurada","La venta ha sido cargada en el formulario."),eh()}catch(e){}},ey=async e=>{try{await (0,p.Kq)(e),(0,v.tP)("Venta Descartada","La venta en espera ha sido eliminada."),eh()}catch(e){}},eb=R.reduce((e,s)=>e+s.quantity*s.price,0),ew=R.reduce((e,s)=>e+s.quantity*s.price*(s.tax_rate/100),0),eC=eb+ew,eS=(null==(e=er.advanced)?void 0:e.allowNegativeStockSales)||!1;console.log("[SALES PAGE] 'allowNegativeSales' is currently: ".concat(eS));let eA=n.useMemo(()=>{if(console.log("[SubmitCheck] Recalculating isSubmitDisabled..."),Z)return console.log("[SubmitCheck] Disabled due to isLoading=true"),!0;let e=R.some(e=>{if(console.log("[SubmitCheck] Checking item: ".concat(e.name||"New Item"," (ID: ").concat(e.productId,")")),!e.productId||e.quantity<=0)return console.log("[SubmitCheck] -> INVALID: No product selected or quantity is zero."),!0;if(eS)return console.log("[SubmitCheck] -> VALID (Negative sales allowed)"),!1;let s=e.quantity>e.availableStock;return s?console.log("[SubmitCheck] -> INVALID: Quantity (".concat(e.quantity,") > Stock (").concat(e.availableStock,")")):console.log("[SubmitCheck] -> VALID: Quantity (".concat(e.quantity,") <= Stock (").concat(e.availableStock,")")),s});return console.log("[SubmitCheck] Final result: isAnyItemInvalid = ".concat(e)),e},[R,Z,eS]),ek=()=>(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-4 px-3 py-2 text-xs font-semibold text-muted-foreground bg-muted",children:[(0,t.jsx)("div",{className:"col-span-2 text-center",children:"C\xf3digo"}),(0,t.jsx)("div",{className:"col-span-4 text-center",children:"Producto"}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:"Stock"}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:"Precio"}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:"IVA"})]}),eI=e=>{let s=em.get(Number(e.value));return s?(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-4 w-full text-sm",children:[(0,t.jsx)("div",{className:"col-span-2 font-mono text-xs text-center",children:s.sku||"N/A"}),(0,t.jsx)("div",{className:"col-span-4 truncate",title:s.name,children:s.name}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:s.stock}),(0,t.jsxs)("div",{className:"col-span-2 text-right",children:["$",s.price.toFixed(2)]}),(0,t.jsxs)("div",{className:"col-span-2 text-right",children:[s.tax_rate.toFixed(2),"%"]})]}):(0,t.jsx)("div",{children:e.label})};return(0,t.jsxs)(k.Bc,{children:[(0,t.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("h1",{className:"font-semibold text-lg md:text-2xl",children:"Ventas"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:ei?"Editando venta a ".concat(I):"Crea y gestiona facturas de venta."})]}),(0,t.jsxs)(f.$,{variant:"outline",onClick:()=>U(!0),disabled:null!==ei,children:[(0,t.jsx)(c.A,{className:"mr-2 h-4 w-4"}),"Historial"]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8 items-start",children:[(0,t.jsx)("div",{className:"lg:col-span-2 space-y-6",children:(0,t.jsxs)(g.Zp,{children:[(0,t.jsx)(g.aR,{children:(0,t.jsx)(g.ZB,{children:ei?"Editar Venta":"Nueva Venta"})}),(0,t.jsx)(g.Wu,{children:(0,t.jsxs)("div",{className:"grid gap-6",children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(b.J,{htmlFor:"clientName",children:"Cliente"}),(0,t.jsx)(y.p,{id:"clientName",value:I,onChange:e=>_(e.target.value),placeholder:"Nombre del cliente"})]}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(b.J,{htmlFor:"clientDni",children:"DNI Cliente"}),(0,t.jsx)(y.p,{id:"clientDni",value:E,onChange:e=>P(e.target.value),placeholder:"C\xe9dula o RIF"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2 items-center mb-2 px-1",children:[(0,t.jsx)("div",{className:"col-span-12 md:col-span-6",children:(0,t.jsx)(b.J,{className:"text-sm font-medium",children:"Producto"})}),(0,t.jsx)("div",{className:"col-span-4 md:col-span-2",children:(0,t.jsx)(b.J,{className:"text-sm font-medium",children:"Cantidad"})}),(0,t.jsx)("div",{className:"col-span-4 md:col-span-2",children:(0,t.jsx)(b.J,{className:"text-sm font-medium",children:"Precio Unit."})}),(0,t.jsx)("div",{className:"col-span-4 md:col-span-2",children:(0,t.jsx)(b.J,{className:"text-sm font-medium text-right w-full pr-2",children:"Acci\xf3n"})})]}),(0,t.jsx)("div",{className:"grid gap-4 border p-4 rounded-md",children:R.map((e,s)=>(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2 items-end",children:[(0,t.jsx)("div",{className:"col-span-12 md:col-span-6",children:(0,t.jsx)(A.G,{open:T===s,onOpenChange:e=>J(e?s:null),options:eu,value:e.productId?String(e.productId):"",onChange:e=>{ep(s,"productId",e),J(null)},placeholder:B?"Cargando...":"Seleccionar...",searchPlaceholder:"Buscar por c\xf3digo o nombre...",emptyMessage:"No hay productos.",disabled:B,popoverClassName:"w-[700px]",align:"start",sideOffset:10,renderHeader:ek,renderOption:eI})}),(0,t.jsxs)("div",{className:"col-span-4 md:col-span-2",children:[(0,t.jsx)(y.p,{type:"number",value:e.quantity,onChange:e=>ep(s,"quantity",e.target.value),min:"1",max:eS?void 0:e.availableStock}),console.log("[InputQty] Item ".concat(e.name,": max set to -> ").concat(eS?"undefined":e.availableStock))]}),(0,t.jsx)("div",{className:"col-span-4 md:col-span-2",children:(0,t.jsx)(y.p,{type:"number",value:e.price,onChange:e=>ep(s,"price",e.target.value),min:"0"})}),(0,t.jsx)("div",{className:"col-span-4 md:col-span-2 flex justify-end",children:(0,t.jsx)(f.$,{variant:"outline",size:"icon",className:"text-muted-foreground",onClick:()=>eN(s),disabled:R.length<=1,children:(0,t.jsx)(r.A,{className:"h-4 w-4"})})})]},e.id))}),(0,t.jsx)("div",{className:"flex items-center gap-2 mt-4",children:(0,t.jsxs)(f.$,{size:"sm",className:"gap-1",onClick:()=>{M(e=>[...e,O()]),J(R.length)},children:[(0,t.jsx)(d.A,{className:"h-3.5 w-3.5"}),"A\xf1adir Producto"]})})]})]})})]})}),(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)(g.Zp,{children:[(0,t.jsx)(g.aR,{children:(0,t.jsx)(g.ZB,{children:"Configuraci\xf3n"})}),(0,t.jsxs)(g.Wu,{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(b.J,{children:"Fecha de Venta"}),(0,t.jsxs)(C.AM,{children:[(0,t.jsx)(C.Wv,{asChild:!0,children:(0,t.jsxs)(f.$,{variant:"outline",className:(0,N.cn)("w-full justify-start text-left font-normal",!s&&"text-muted-foreground"),children:[(0,t.jsx)(o.A,{className:"mr-2 h-4 w-4"}),s?(0,l.GP)(s,"PPP",{locale:i.es}):(0,t.jsx)("span",{children:"Seleccione fecha"})]})}),(0,t.jsx)(C.hl,{className:"w-auto p-0",children:(0,t.jsx)(S.V,{mode:"single",selected:s,onSelect:e=>a(e||new Date),initialFocus:!0})})]})]}),(0,t.jsxs)("div",{className:"grid gap-2",children:[(0,t.jsx)(b.J,{htmlFor:"invoiceNumber",children:"N\xba de Factura"}),(0,t.jsx)(y.p,{id:"invoiceNumber",value:$,onChange:e=>F(e.target.value),placeholder:"Opcional"})]})]})]}),(0,t.jsxs)(g.Zp,{children:[(0,t.jsx)(g.aR,{children:(0,t.jsx)(g.ZB,{children:"Resumen"})}),(0,t.jsxs)(g.Wu,{className:"grid gap-4",children:[(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Subtotal"}),(0,t.jsxs)("span",{children:["$",eb.toFixed(2)]})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"Impuestos"}),(0,t.jsxs)("span",{children:["$",ew.toFixed(2)]})]}),(0,t.jsx)(w.w,{}),(0,t.jsxs)("div",{className:"flex justify-between font-semibold text-lg",children:[(0,t.jsx)("span",{children:"Total"}),(0,t.jsxs)("span",{children:["$",eC.toFixed(2)]})]})]})]}),(0,t.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,t.jsxs)(f.$,{onClick:()=>{let e=new Map;R.filter(e=>null!==e.productId).forEach(s=>{let a=s.productId;if(e.has(a)){let t=e.get(a);t.quantity+=s.quantity}else e.set(a,{productId:a,name:s.name,quantity:s.quantity,unitPrice:s.price,tax_rate:s.tax_rate})}),et(Array.from(e.values())),es(!0)},disabled:eA,size:"lg",children:[Z&&(0,t.jsx)(x.A,{className:"mr-2 h-4 w-4 animate-spin"}),Z?"Procesando...":ei?"Guardar Cambios":"Registrar Venta"]}),ei&&(0,t.jsxs)(f.$,{variant:"ghost",onClick:ej,children:[(0,t.jsx)(h.A,{className:"mr-2 h-4 w-4"}),"Cancelar Edici\xf3n"]}),(0,t.jsx)(f.$,{variant:"secondary",onClick:eg,disabled:null!==ei,children:"Poner en Espera"})]}),W.length>0&&(0,t.jsxs)(g.Zp,{children:[(0,t.jsxs)(g.aR,{children:[(0,t.jsx)(g.ZB,{children:"Ventas en Espera"}),(0,t.jsx)(g.BT,{children:"Restaura o elimina las ventas que dejaste pendientes."})]}),(0,t.jsx)(g.Wu,{className:"space-y-4",children:W.map(e=>(0,t.jsxs)("div",{className:"flex items-center justify-between p-2 border rounded-lg",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-medium",children:e.clientName||"Cliente General"}),(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:[e.cart.length," producto(s) - ",(0,l.GP)(e.createdAt,"p",{locale:i.es})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)(k.m_,{children:[(0,t.jsx)(k.k$,{asChild:!0,children:(0,t.jsx)(f.$,{variant:"outline",size:"icon",onClick:()=>ef(e),children:(0,t.jsx)(m.A,{className:"h-4 w-4"})})}),(0,t.jsx)(k.ZI,{children:(0,t.jsx)("p",{children:"Restaurar"})})]}),(0,t.jsxs)(k.m_,{children:[(0,t.jsx)(k.k$,{asChild:!0,children:(0,t.jsx)(f.$,{variant:"destructive",size:"icon",onClick:()=>ey(e.id),children:(0,t.jsx)(u.A,{className:"h-4 w-4"})})}),(0,t.jsx)(k.ZI,{children:(0,t.jsx)("p",{children:"Eliminar"})})]})]})]},e.id))})]})]})]})]}),(0,t.jsx)(D,{open:Q,onOpenChange:U,onViewReceipt:e=>{el(e.transaction_id),Y(!0)},onEditSale:e=>{a(new Date(e.transaction_date)),_(e.entity_name),P("N/A"!==e.entity_document?e.entity_document:""),F(e.document_number);let s=new Map;e.movements.forEach(e=>{let a=em.get(e.productId);if(s.has(e.productId)){let a=s.get(e.productId);a.quantity+=e.quantity}else s.set(e.productId,{id:"edit-consolidated-".concat(e.productId),productId:e.productId,name:e.productName,quantity:e.quantity,price:e.unit_price,tax_rate:(null==a?void 0:a.tax_rate)||0,availableStock:((null==a?void 0:a.stock)||0)+e.quantity})}),M(Array.from(s.values())),ec(e.transaction_id),U(!1)},refetchKey:ex}),(0,t.jsx)(L.d,{open:X,onOpenChange:e=>{e||el(null),Y(e)},transactionId:en}),(0,t.jsx)(G,{open:ee,onOpenChange:es,saleItems:ea,onConfirm:ev,isSaving:Z})]})}}},e=>{var s=s=>e(e.s=s);e.O(0,[130,134,131,748,655,841,240,86,441,684,358],()=>s(2948)),_N_E=e.O()}]);